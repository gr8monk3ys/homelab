---
# PrometheusRule for Pod-related alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: pod-alerts
  namespace: monitoring
  labels:
    app: kube-prometheus-stack
    prometheus: kube-prometheus
spec:
  groups:
  - name: pod-health
    rules:
    # Pod restart alerts
    - alert: PodCrashLooping
      expr: increase(kube_pod_container_status_restarts_total[1h]) > 3
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
        description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} has restarted {{ $value }} times in the last hour"

    - alert: PodCrashLoopingCritical
      expr: increase(kube_pod_container_status_restarts_total[1h]) > 10
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping excessively"
        description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} has restarted {{ $value }} times in the last hour"

    # Pod not ready
    - alert: PodNotReady
      expr: |
        sum by (namespace, pod) (
          max by(namespace, pod) (kube_pod_status_phase{phase=~"Pending|Unknown"}) * on(namespace, pod) group_left(owner_kind) max by(namespace, pod, owner_kind) (kube_pod_owner{owner_kind!="Job"})
        ) > 0
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is not ready"
        description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} has been in a non-ready state for more than 15 minutes"

    # Container waiting
    - alert: ContainerWaiting
      expr: sum by (namespace, pod, container) (kube_pod_container_status_waiting_reason{reason!="ContainerCreating"}) > 0
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Container {{ $labels.container }} in {{ $labels.namespace }}/{{ $labels.pod }} is waiting"
        description: "Container {{ $labels.container }} has been waiting for more than 10 minutes"

  - name: pod-resources
    rules:
    # High CPU usage
    - alert: PodHighCPUUsage
      expr: |
        sum(rate(container_cpu_usage_seconds_total{container!="", container!="POD"}[5m])) by (namespace, pod)
        / sum(kube_pod_container_resource_limits{resource="cpu"}) by (namespace, pod) > 0.9
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} has high CPU usage"
        description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is using more than 90% of CPU limit"

    # High memory usage
    - alert: PodHighMemoryUsage
      expr: |
        sum(container_memory_working_set_bytes{container!="", container!="POD"}) by (namespace, pod)
        / sum(kube_pod_container_resource_limits{resource="memory"}) by (namespace, pod) > 0.9
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} has high memory usage"
        description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is using more than 90% of memory limit"

    # OOMKilled
    - alert: ContainerOOMKilled
      expr: kube_pod_container_status_last_terminated_reason{reason="OOMKilled"} == 1
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "Container {{ $labels.container }} in {{ $labels.namespace }}/{{ $labels.pod }} was OOMKilled"
        description: "Container {{ $labels.container }} was killed due to out of memory"
