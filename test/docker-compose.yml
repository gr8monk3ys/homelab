version: '3.8'

networks:
  homelab:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16

volumes:
  nextcloud_data:
  nextcloud_db:
  vaultwarden_data:
  jellyfin_config:
  jellyfin_cache:
  grafana_data:
  prometheus_data:
  pihole_data:
  pihole_dnsmasq:
  gitea_data:
  gitea_db:
  harbor_data:
  harbor_db:
  minio_data:
  searxng_redis:
  calibre_config:
  calibre_books:
  yarr_data:

services:
  # Reverse Proxy
  traefik:
    image: traefik:v2.10
    container_name: traefik
    command:
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
    ports:
      - "80:80"
      - "443:443"
      - "8081:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - homelab

  # DNS & Ad Blocking
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    hostname: pihole
    ports:
      - "5454:53/tcp"
      - "5454:53/udp"
    environment:
      TZ: 'UTC'
      WEBPASSWORD: 'admin123'
      PIHOLE_DNS_: '1.1.1.1;8.8.8.8'
    volumes:
      - pihole_data:/etc/pihole
      - pihole_dnsmasq:/etc/dnsmasq.d
    networks:
      - homelab
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pihole.rule=Host(`pihole.homelab.local`)"
      - "traefik.http.services.pihole.loadbalancer.server.port=80"

  # File Sync & Sharing
  nextcloud-db:
    image: mysql:8.0
    container_name: nextcloud-db
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: rootpass123
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: nextcloud123
    volumes:
      - nextcloud_db:/var/lib/mysql
    networks:
      - homelab

  nextcloud:
    image: nextcloud:apache
    container_name: nextcloud
    depends_on:
      - nextcloud-db
    environment:
      MYSQL_HOST: nextcloud-db
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: nextcloud123
      NEXTCLOUD_ADMIN_USER: admin
      NEXTCLOUD_ADMIN_PASSWORD: nextcloud123
    volumes:
      - nextcloud_data:/var/www/html
    networks:
      - homelab
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`nextcloud.homelab.local`)"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"

  # Password Manager
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    environment:
      ADMIN_TOKEN: "change-me-please"
      WEBSOCKET_ENABLED: "true"
    volumes:
      - vaultwarden_data:/data
    networks:
      - homelab
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vaultwarden.rule=Host(`vault.homelab.local`)"
      - "traefik.http.services.vaultwarden.loadbalancer.server.port=80"

  # Media Server
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    environment:
      - JELLYFIN_PublishedServerUrl=http://jellyfin.homelab.local
    volumes:
      - jellyfin_config:/config
      - jellyfin_cache:/cache
      - ./media:/media:ro  # Mount your media directory here
    networks:
      - homelab
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.homelab.local`)"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"

  # Monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - homelab

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin123
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - homelab
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.homelab.local`)"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  # Git Server
  gitea-db:
    image: postgres:15
    container_name: gitea-db
    environment:
      POSTGRES_USER: gitea
      POSTGRES_PASSWORD: gitea-db-pass
      POSTGRES_DB: gitea
    volumes:
      - gitea_db:/var/lib/postgresql/data
    networks:
      - homelab

  gitea:
    image: gitea/gitea:latest
    container_name: gitea
    depends_on:
      - gitea-db
    environment:
      USER_UID: 1000
      USER_GID: 1000
      GITEA__database__DB_TYPE: postgres
      GITEA__database__HOST: gitea-db:5432
      GITEA__database__NAME: gitea
      GITEA__database__USER: gitea
      GITEA__database__PASSWD: gitea-db-pass
      GITEA__server__DOMAIN: git.homelab.local
      GITEA__server__ROOT_URL: http://git.homelab.local
    volumes:
      - gitea_data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "3000:3000"
      - "2222:22"
    networks:
      - homelab
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitea.rule=Host(`git.homelab.local`)"
      - "traefik.http.services.gitea.loadbalancer.server.port=3000"

  # Container Registry
  harbor-db:
    image: postgres:15
    container_name: harbor-db
    environment:
      POSTGRES_PASSWORD: Harbor12345
      POSTGRES_USER: postgres
      POSTGRES_DB: registry
    volumes:
      - harbor_db:/var/lib/postgresql/data
    networks:
      - homelab

  harbor-redis:
    image: redis:7-alpine
    container_name: harbor-redis
    networks:
      - homelab

  registry:
    image: goharbor/harbor-core:v2.8.0
    container_name: harbor-core
    depends_on:
      - harbor-db
      - harbor-redis
    environment:
      CORE_SECRET: Harbor12345
      JOBSERVICE_SECRET: Harbor12345
      DATABASE_TYPE: postgresql
      DATABASE_HOST: harbor-db
      DATABASE_PORT: 5432
      DATABASE_USERNAME: postgres
      DATABASE_PASSWORD: Harbor12345
      DATABASE_DATABASE: registry
      REDIS_URL: redis://harbor-redis:6379/0
    networks:
      - homelab
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.registry.rule=Host(`registry.homelab.local`)"
      - "traefik.http.services.registry.loadbalancer.server.port=8080"

  # Object Storage
  minio:
    image: minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - homelab
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio.rule=Host(`minio.homelab.local`)"
      - "traefik.http.services.minio.loadbalancer.server.port=9001"

  # Dashboard
  heimdall:
    image: lscr.io/linuxserver/heimdall:latest
    container_name: heimdall
    environment:
      PUID: 1000
      PGID: 1000
      TZ: UTC
    volumes:
      - ./heimdall_config:/config
    networks:
      - homelab
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.heimdall.rule=Host(`dashboard.homelab.local`)"
      - "traefik.http.services.heimdall.loadbalancer.server.port=80"

  # Private Search Engine
  searxng-redis:
    image: redis:7-alpine
    container_name: searxng-redis
    volumes:
      - searxng_redis:/data
    networks:
      - homelab

  searxng:
    image: searxng/searxng:latest
    container_name: searxng
    depends_on:
      - searxng-redis
    environment:
      SEARXNG_BASE_URL: "http://search.homelab.local"
      SEARXNG_SECRET: "searxng-secret-key-123"
      SEARXNG_REDIS_URL: "redis://searxng-redis:6379"
    volumes:
      - ./config/searxng:/etc/searxng
    networks:
      - homelab
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.searxng.rule=Host(`search.homelab.local`)"
      - "traefik.http.services.searxng.loadbalancer.server.port=8080"

  # Digital Library
  calibre-web:
    image: lscr.io/linuxserver/calibre-web:latest
    container_name: calibre-web
    environment:
      PUID: 1000
      PGID: 1000
      TZ: UTC
      DOCKER_MODS: "linuxserver/mods:universal-calibre"
    volumes:
      - calibre_config:/config
      - calibre_books:/books
      - ./books:/import:ro  # Mount for importing books
    networks:
      - homelab
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.calibre-web.rule=Host(`books.homelab.local`)"
      - "traefik.http.services.calibre-web.loadbalancer.server.port=8083"

  # RSS Feed Reader
  yarr:
    image: itsnoted/yarr:latest
    container_name: yarr
    environment:
      YARR_ADDR: "0.0.0.0:7070"
      YARR_DB: "/data/yarr.db"
      YARR_AUTH: "admin:yarrPass123"
    volumes:
      - yarr_data:/data
    networks:
      - homelab
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.yarr.rule=Host(`rss.homelab.local`)"
      - "traefik.http.services.yarr.loadbalancer.server.port=7070"