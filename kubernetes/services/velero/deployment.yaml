---
# Velero - Kubernetes Backup and Disaster Recovery
# https://velero.io/
#
# This deployment uses MinIO as the S3-compatible storage backend.
# Velero backs up Kubernetes resources and persistent volumes.
#
# Prerequisites:
# 1. MinIO must be running and accessible
# 2. Create a bucket named 'velero' in MinIO
# 3. Configure the secret with MinIO credentials
apiVersion: v1
kind: ServiceAccount
metadata:
  name: velero
  namespace: velero
  labels:
    app.kubernetes.io/name: velero
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: velero
  labels:
    app.kubernetes.io/name: velero
subjects:
- kind: ServiceAccount
  name: velero
  namespace: velero
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
---
# Velero credentials for MinIO
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: velero-credentials
  namespace: velero
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: homelab-secret-store
    kind: ClusterSecretStore
  target:
    name: velero-credentials
    creationPolicy: Owner
    template:
      data:
        cloud: |
          [default]
          aws_access_key_id={{ .access_key }}
          aws_secret_access_key={{ .secret_key }}
  data:
  - secretKey: access_key
    remoteRef:
      key: minio-credentials
      property: access-key
  - secretKey: secret_key
    remoteRef:
      key: minio-credentials
      property: secret-key
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: velero
  namespace: velero
  labels:
    app.kubernetes.io/name: velero
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: velero
  template:
    metadata:
      labels:
        app.kubernetes.io/name: velero
    spec:
      serviceAccountName: velero
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
      initContainers:
      - name: velero-plugin-for-aws
        image: velero/velero-plugin-for-aws:v1.10.0
        imagePullPolicy: IfNotPresent
        volumeMounts:
        - name: plugins
          mountPath: /target
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
      containers:
      - name: velero
        image: velero/velero:v1.14.1
        args:
        - server
        - --features=EnableCSI
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
        env:
        - name: VELERO_SCRATCH_DIR
          value: /scratch
        - name: VELERO_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: LD_LIBRARY_PATH
          value: /plugins
        - name: AWS_SHARED_CREDENTIALS_FILE
          value: /credentials/cloud
        ports:
        - containerPort: 8085
          name: metrics
        volumeMounts:
        - name: plugins
          mountPath: /plugins
        - name: scratch
          mountPath: /scratch
        - name: credentials
          mountPath: /credentials
          readOnly: true
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /metrics
            port: 8085
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /metrics
            port: 8085
          initialDelaySeconds: 5
          periodSeconds: 10
      volumes:
      - name: plugins
        emptyDir: {}
      - name: scratch
        emptyDir: {}
      - name: credentials
        secret:
          secretName: velero-credentials
---
# BackupStorageLocation - Where backups are stored (MinIO)
apiVersion: velero.io/v1
kind: BackupStorageLocation
metadata:
  name: default
  namespace: velero
spec:
  provider: aws
  objectStorage:
    bucket: velero
    prefix: backups
  config:
    region: us-east-1
    s3ForcePathStyle: "true"
    s3Url: http://minio.minio.svc.cluster.local:9000
---
# VolumeSnapshotLocation - For CSI snapshots
apiVersion: velero.io/v1
kind: VolumeSnapshotLocation
metadata:
  name: default
  namespace: velero
spec:
  provider: aws
  config:
    region: us-east-1
---
# Default backup schedule - Daily at 2 AM, retain for 30 days
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: daily-backup
  namespace: velero
spec:
  schedule: "0 2 * * *"
  template:
    includedNamespaces:
    - "*"
    excludedNamespaces:
    - kube-system
    - kube-public
    - kube-node-lease
    - velero
    storageLocation: default
    volumeSnapshotLocations:
    - default
    ttl: 720h  # 30 days
    includeClusterResources: true
---
# Weekly full backup - Sundays at 3 AM, retain for 90 days
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: weekly-backup
  namespace: velero
spec:
  schedule: "0 3 * * 0"
  template:
    includedNamespaces:
    - "*"
    excludedNamespaces:
    - kube-system
    - kube-public
    - kube-node-lease
    storageLocation: default
    volumeSnapshotLocations:
    - default
    ttl: 2160h  # 90 days
    includeClusterResources: true
---
apiVersion: v1
kind: Service
metadata:
  name: velero
  namespace: velero
  labels:
    app.kubernetes.io/name: velero
spec:
  selector:
    app.kubernetes.io/name: velero
  ports:
  - name: metrics
    port: 8085
    targetPort: 8085
  type: ClusterIP
---
# ServiceMonitor for Prometheus
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: velero
  namespace: velero
  labels:
    app.kubernetes.io/name: velero
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: velero
  endpoints:
  - port: metrics
    interval: 30s
