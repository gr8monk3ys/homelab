---
# PrometheusRule for Storage-related alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: storage-alerts
  namespace: monitoring
  labels:
    app: kube-prometheus-stack
    prometheus: kube-prometheus
spec:
  groups:
  - name: persistent-volumes
    rules:
    # PVC almost full
    - alert: PersistentVolumeAlmostFull
      expr: |
        kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes > 0.85
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "PVC {{ $labels.persistentvolumeclaim }} in {{ $labels.namespace }} is almost full"
        description: "PVC {{ $labels.persistentvolumeclaim }} is more than 85% full"

    # PVC critically full
    - alert: PersistentVolumeCriticallyFull
      expr: |
        kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes > 0.95
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "PVC {{ $labels.persistentvolumeclaim }} in {{ $labels.namespace }} is critically full"
        description: "PVC {{ $labels.persistentvolumeclaim }} is more than 95% full"

    # PV pending
    - alert: PersistentVolumePending
      expr: kube_persistentvolume_status_phase{phase="Pending"} == 1
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "PersistentVolume {{ $labels.persistentvolume }} is pending"
        description: "PV {{ $labels.persistentvolume }} has been pending for more than 15 minutes"

    # PV failed
    - alert: PersistentVolumeFailed
      expr: kube_persistentvolume_status_phase{phase="Failed"} == 1
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "PersistentVolume {{ $labels.persistentvolume }} has failed"
        description: "PV {{ $labels.persistentvolume }} is in a failed state"

    # PVC pending
    - alert: PersistentVolumeClaimPending
      expr: kube_persistentvolumeclaim_status_phase{phase="Pending"} == 1
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "PVC {{ $labels.persistentvolumeclaim }} in {{ $labels.namespace }} is pending"
        description: "PVC {{ $labels.persistentvolumeclaim }} has been pending for more than 15 minutes"
