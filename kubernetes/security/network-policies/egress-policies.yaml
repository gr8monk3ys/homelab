---
# Default deny egress policies for sensitive namespaces
# These policies block all outbound traffic by default, then allow specific destinations

# =============================================================================
# VAULTWARDEN - Password manager (highly sensitive, minimal egress needed)
# =============================================================================
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: vaultwarden
spec:
  podSelector: {}
  policyTypes:
    - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: vaultwarden
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

# =============================================================================
# AUTHELIA - Authentication service (needs DNS only for internal auth)
# =============================================================================
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: authelia
spec:
  podSelector: {}
  policyTypes:
    - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: authelia
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-redis-egress
  namespace: authelia
spec:
  podSelector:
    matchLabels:
      app: authelia
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: authelia-redis
      ports:
        - protocol: TCP
          port: 6379

# =============================================================================
# NEXTCLOUD - File storage (needs external for federation, apps, updates)
# =============================================================================
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: nextcloud
spec:
  podSelector: {}
  policyTypes:
    - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: nextcloud
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-mysql-egress
  namespace: nextcloud
spec:
  podSelector:
    matchLabels:
      app: nextcloud
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: nextcloud-mysql
      ports:
        - protocol: TCP
          port: 3306
---
# Nextcloud needs external HTTPS for app store, federation, updates
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-https-egress
  namespace: nextcloud
spec:
  podSelector:
    matchLabels:
      app: nextcloud
  policyTypes:
    - Egress
  egress:
    - ports:
        - protocol: TCP
          port: 443

# =============================================================================
# PAPERLESS-NGX - Document management (minimal external access)
# =============================================================================
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: paperless-ngx
spec:
  podSelector: {}
  policyTypes:
    - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: paperless-ngx
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-postgres-egress
  namespace: paperless-ngx
spec:
  podSelector:
    matchLabels:
      app: paperless
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: paperless-postgres
      ports:
        - protocol: TCP
          port: 5432
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-redis-egress
  namespace: paperless-ngx
spec:
  podSelector:
    matchLabels:
      app: paperless
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: paperless-redis
      ports:
        - protocol: TCP
          port: 6379

# =============================================================================
# IMMICH - Photo management (needs ML services internally)
# =============================================================================
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: immich
spec:
  podSelector: {}
  policyTypes:
    - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: immich
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-internal-services-egress
  namespace: immich
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow all internal Immich communication
    - to:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 5432  # Postgres
        - protocol: TCP
          port: 6379  # Redis
        - protocol: TCP
          port: 3003  # ML service

# =============================================================================
# GITEA - Git server (needs external for mirroring, webhooks)
# =============================================================================
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: gitea
spec:
  podSelector: {}
  policyTypes:
    - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: gitea
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-postgres-egress
  namespace: gitea
spec:
  podSelector:
    matchLabels:
      app: gitea
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: gitea-postgres
      ports:
        - protocol: TCP
          port: 5432
---
# Gitea needs external access for repository mirroring and webhooks
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-external-egress
  namespace: gitea
spec:
  podSelector:
    matchLabels:
      app: gitea
  policyTypes:
    - Egress
  egress:
    - ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 22  # SSH for git operations

# =============================================================================
# LINKWARDEN - Bookmark manager (needs external for fetching pages)
# =============================================================================
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: linkwarden
spec:
  podSelector: {}
  policyTypes:
    - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: linkwarden
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-postgres-egress
  namespace: linkwarden
spec:
  podSelector:
    matchLabels:
      app: linkwarden
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: linkwarden-postgres
      ports:
        - protocol: TCP
          port: 5432
---
# Linkwarden needs external access to fetch bookmarked pages
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-http-egress
  namespace: linkwarden
spec:
  podSelector:
    matchLabels:
      app: linkwarden
  policyTypes:
    - Egress
  egress:
    - ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443

# =============================================================================
# N8N - Automation (needs external for webhooks and integrations)
# =============================================================================
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: n8n
spec:
  podSelector: {}
  policyTypes:
    - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: n8n
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-postgres-egress
  namespace: n8n
spec:
  podSelector:
    matchLabels:
      app: n8n
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: n8n-postgres
      ports:
        - protocol: TCP
          port: 5432
---
# n8n needs broad external access for automations
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-http-egress
  namespace: n8n
spec:
  podSelector:
    matchLabels:
      app: n8n
  policyTypes:
    - Egress
  egress:
    - ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443
